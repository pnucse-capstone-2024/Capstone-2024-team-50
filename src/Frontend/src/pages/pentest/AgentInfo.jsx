import React, {useContext, useEffect, useState} from 'react';
import { UserContext } from '../../core/user';
import { fetchAgents } from '../../services/AgentServices';

import { Button, Typography } from '@mui/material'

import AgentInfoGrid from './module/AgentInfoGrid';
import AddAgentDialog from './module/AddAgentDialog';

import { fetchDeleteAgent } from '../../services/AgentServices';

const AgentInfo = ({view}) => {
    const { userState } = useContext(UserContext);
    const [rows, setRows] = useState([])
    const [agentID, setAgentID] = useState(null);

    const handleAgent = () => {
      fetchAgents(userState.uid)
        .then(response => response.json())
        .then(data => {
          setRows(data);
        })
        .catch(error => {
          console.error('Error fetching agents:', error);
        });
    }

    useEffect(() => {
      if (userState && userState.uid) {
        const intervalId = setInterval(() => {
          handleAgent();
        }, 1000);
      } else {
        console.warn('User state or user UID is not available');
      }
    }, [userState]);

    const handleDeleteAgent = () => {
      fetchDeleteAgent(agentID)
        .then(response => response.json())
        .then(data => {
          console.log('Deleted agent:', data);
          handleAgent();
        })
        .catch(error => {
          console.error('Error deleting agent:', error);
        });
    }

    return (
        <div>
            <div className='flex flex-row'>
                {!view && <Typography variant='h4' sx={{fontWeight:'bold'}}>Agent Infomation</Typography>}
                <div className='ml-auto'>
                    <AddAgentDialog uid={userState.uid} />
                    {/* <Button variant='contained' sx={{ml:2}}>
                        수정
                    </Button> */}
                    <Button variant='contained' sx={{ml:2}} onClick={handleDeleteAgent}>
                        삭제
                    </Button>
                </div>
            </div>
            <AgentInfoGrid rows={rows} setRows={setRows} setAgentID={setAgentID}/>
        </div>
    )
}

export default AgentInfo;